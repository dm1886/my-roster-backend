<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyRoster Admin Panel - Enhanced Roster Viewer</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
        .container{background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);width:100%;max-width:1400px;overflow:hidden}
        .login-container{max-width:400px;padding:40px}.admin-container{display:none}
        .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center;position:relative}
        .header h1{font-size:28px;margin-bottom:10px}.header p{opacity:.9;font-size:14px}
        .content{padding:30px}.form-group{margin-bottom:20px}label{display:block;margin-bottom:8px;color:#333;font-weight:500;font-size:14px}
        input,select{width:100%;padding:12px;border:2px solid #e1e8ed;border-radius:8px;font-size:14px;transition:border-color .3s}
        input:focus,select:focus{outline:none;border-color:#667eea}
        .btn{width:100%;padding:14px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:transform .2s,box-shadow .2s}
        .btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(102,126,234,.4)}
        .btn:active{transform:translateY(0)}.btn-secondary{background:#6c757d;margin-top:10px}.btn-danger{background:#dc3545}.btn-success{background:#28a745}
        .error{background:#fee;color:#c33;padding:12px;border-radius:8px;margin-bottom:20px;border-left:4px solid #c33}
        .tabs{display:flex;border-bottom:2px solid #e1e8ed;margin-bottom:30px}.tab{padding:15px 30px;cursor:pointer;color:#666;font-weight:500;border-bottom:3px solid transparent;transition:all .3s}
        .tab:hover{color:#667eea}.tab.active{color:#667eea;border-bottom-color:#667eea}
        .tab-content{display:none}.tab-content.active{display:block}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(102,126,234,.3)}
        .stat-card h3{font-size:14px;opacity:.9;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px}.stat-card .value{font-size:36px;font-weight:700;margin-bottom:5px}.stat-card .label{font-size:12px;opacity:.8}
        table{width:100%;border-collapse:collapse;margin-top:20px}th{background:#f8f9fa;padding:15px;text-align:left;font-weight:600;color:#333;border-bottom:2px solid #e1e8ed}td{padding:15px;border-bottom:1px solid #e1e8ed}tr:hover{background:#f8f9fa}
        .badge{display:inline-block;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600}.badge-pending{background:#fff3cd;color:#856404}.badge-resolved{background:#d4edda;color:#155724}.badge-ignored{background:#d6d8db;color:#383d41}
        .search-box{margin-bottom:20px}.filters{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}.filter-group{flex:1;min-width:200px}
        .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center}.modal.active{display:flex}
        .modal-content{background:white;border-radius:12px;padding:30px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.modal-header h2{color:#333}.close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#999}.close-btn:hover{color:#333}
        .detail-row{display:flex;padding:12px 0;border-bottom:1px solid #e1e8ed}.detail-label{font-weight:600;min-width:180px;color:#666}.detail-value{flex:1;color:#333}
        .code-block{background:#f8f9fa;padding:15px;border-radius:8px;font-family:'Courier New',monospace;white-space:pre-wrap;word-break:break-all;margin:10px 0;font-size:13px;border:1px solid #e1e8ed}
        .logout-btn{position:absolute;top:20px;right:30px;background:rgba(255,255,255,.2);color:white;border:2px solid white;padding:8px 20px;border-radius:20px;cursor:pointer;font-weight:600;transition:all .3s}.logout-btn:hover{background:white;color:#667eea}
        .pagination{display:flex;justify-content:center;gap:10px;margin-top:20px}.pagination button{padding:8px 16px;background:white;border:2px solid #e1e8ed;border-radius:6px;cursor:pointer;transition:all .3s}.pagination button:hover:not(:disabled){border-color:#667eea;color:#667eea}.pagination button:disabled{opacity:.5;cursor:not-allowed}
        .loading{text-align:center;padding:40px;color:#999}.spinner{border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
        .empty-state{text-align:center;padding:60px 20px;color:#999}

        /* Enhanced Roster Viewer */
        .roster-period{background:#fff;border:2px solid #e1e8ed;border-radius:10px;padding:18px;margin-bottom:15px;cursor:pointer;transition:all .3s;position:relative}
        .roster-period:hover{border-color:#667eea;box-shadow:0 4px 12px rgba(102,126,234,.2)}
        .period-header{display:flex;justify-content:space-between;align-items:center}
        .period-title{font-size:18px;font-weight:700;color:#333}.period-meta{font-size:13px;color:#666;margin-top:6px}
        .period-arrow{position:absolute;right:20px;top:50%;transform:translateY(-50%);font-size:20px;color:#667eea;transition:transform .3s}
        .period-arrow.open{transform:translateY(-50%) rotate(90deg)}
        .roster-days-container{margin-top:15px;display:none;padding-left:20px;border-left:3px solid #667eea}
        .roster-days-container.open{display:block}
        
        .roster-day-item{background:#fafbfc;border:1px solid #e1e8ed;border-radius:8px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all .2s}
        .roster-day-item:hover{background:#f0f4f8;border-color:#667eea}
        .day-header{display:flex;justify-content:space-between;align-items:center;font-size:15px;font-weight:600}
        .day-date{color:#667eea}.day-info{font-size:13px;color:#666;margin-top:4px}
        .day-arrow{font-size:16px;color:#999}
        
        .duties-container{margin-top:12px;display:none;padding-left:15px;border-left:2px solid #ddd}
        .duties-container.open{display:block}
        
        .duty-card{background:#fff;border:1px solid #e1e8ed;border-radius:6px;padding:12px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
        .duty-header{display:flex;gap:10px;align-items:center;margin-bottom:8px}
        .duty-kind-badge{background:#667eea;color:white;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase}
        .duty-type-badge{background:#f0f0f0;color:#333;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .duty-field{font-size:13px;margin:6px 0;color:#555}.duty-field strong{color:#333;min-width:120px;display:inline-block}
        .duty-notes{background:#fff9e6;border-left:3px solid #ffc107;padding:8px;margin-top:8px;font-size:12px;color:#856404}
        
        .sectors-container{margin-top:10px;padding-left:10px}
        .sector-card{background:#f8fff8;border:1px solid #c3e6cb;border-left:3px solid #28a745;padding:10px;margin-bottom:8px;border-radius:4px}
        .sector-route{font-size:14px;font-weight:700;color:#155724;margin-bottom:6px}
        .sector-field{font-size:12px;margin:4px 0;color:#555}.sector-field strong{min-width:140px;display:inline-block;color:#333}
        .crew-list{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}.crew-badge{background:#007bff;color:white;padding:2px 8px;border-radius:10px;font-size:11px}
        
        .view-json-btn{background:#17a2b8;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;margin-top:8px}
        .view-json-btn:hover{background:#138496}
        
        .json-viewer{background:#1e1e1e;color:#d4d4d4;padding:20px;border-radius:8px;margin-top:15px;font-family:'Courier New',monospace;font-size:13px;line-height:1.6;overflow-x:auto;max-height:500px}
        .json-key{color:#9cdcfe}.json-string{color:#ce9178}.json-number{color:#b5cea8}.json-boolean{color:#569cd6}.json-null{color:#808080}
    </style>
</head>
<body>
    <!-- LOGIN VIEW -->
    <div class="container login-container" id="loginView">
        <div class="header"><h1>üõ´ MyRoster Admin</h1><p>Backend Management Panel</p></div>
        <div class="content">
            <div id="loginError" class="error" style="display:none;"></div>
            <form id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="email" required placeholder="admin@example.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="btn">Login</button>
            </form>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div class="container admin-container" id="adminView">
        <div class="header"><h1>üõ´ MyRoster Admin Panel</h1><p id="userInfo"></p><button class="logout-btn" onclick="logout()">Logout</button></div>
        <div class="content">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
                <div class="tab" onclick="switchTab('users')">üë• Users</div>
                <div class="tab" onclick="switchTab('unknown')">‚ùì Unknown Rosters</div>
                <div class="tab" onclick="switchTab('roster')">üìÖ Roster Viewer</div>
            </div>

            <!-- DASHBOARD -->
            <div class="tab-content active" id="dashboard"><div class="stats-grid" id="statsGrid"><div class="loading"><div class="spinner"></div>Loading statistics...</div></div><div id="topPatterns"></div></div>

            <!-- USERS -->
            <div class="tab-content" id="users">
                <h2>Registered Users</h2><div class="search-box"><input type="text" id="userSearch" placeholder="Search by email, name, or staff number..." onkeyup="searchUsers()"></div>
                <div id="usersTable"><div class="loading"><div class="spinner"></div>Loading users...</div></div><div class="pagination" id="usersPagination"></div>
            </div>

            <!-- UNKNOWN ROSTERS -->
            <div class="tab-content" id="unknown">
                <h2>Unknown Roster Codes</h2>
                <div class="filters">
                    <div class="filter-group"><label>Status</label><select id="statusFilter" onchange="loadUnknownRosters()"><option value="pending">Pending</option><option value="resolved">Resolved</option><option value="ignored">Ignored</option></select></div>
                    <div class="filter-group"><label>Sort By</label><select id="sortFilter" onchange="loadUnknownRosters()"><option value="last_reported_at">Last Reported</option><option value="reported_at">First Reported</option><option value="report_count">Report Count</option></select></div>
                    <div class="filter-group"><label>Search</label><input type="text" id="unknownSearch" placeholder="Search in raw text..." onkeyup="searchUnknown()"></div>
                </div>
                <div id="unknownTable"><div class="loading"><div class="spinner"></div>Loading unknown rosters...</div></div><div class="pagination" id="unknownPagination"></div>
            </div>

            <!-- ENHANCED ROSTER VIEWER -->
            <div class="tab-content" id="roster">
                <h2 style="margin-bottom:20px">üìÖ Comprehensive Roster Database Viewer</h2>
                <p style="color:#666;margin-bottom:20px">Click on any period to expand days, then click days to see detailed duty assignments and sectors with all database fields</p>
                <div id="rosterTree"><div class="loading"><div class="spinner"></div>Loading roster periods...</div></div>
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal" id="detailModal"><div class="modal-content"><div class="modal-header"><h2>Details</h2><button class="close-btn" onclick="closeModal()">&times;</button></div><div id="modalContent"></div></div></div>

    <script>
        let token=localStorage.getItem('adminToken'),currentUser=null,usersOffset=0,unknownOffset=0,LIMIT=20;
        if(token)showAdminView();
        
        document.getElementById('loginForm').addEventListener('submit',async(e)=>{
            e.preventDefault();
            const email=document.getElementById('email').value,password=document.getElementById('password').value;
            try{
                const res=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
                const data=await res.json();
                if(res.ok){token=data.token;currentUser=data.user;localStorage.setItem('adminToken',token);showAdminView();}
                else showError(data.error||'Login failed');
            }catch{showError('Network error');}
        });
        
        function showError(msg){const el=document.getElementById('loginError');el.textContent=msg;el.style.display='block';}
        function showAdminView(){
            document.getElementById('loginView').style.display='none';
            document.getElementById('adminView').style.display='block';
            document.getElementById('userInfo').textContent=currentUser?`Logged in as ${currentUser.email}`:'';
            loadDashboard();
        }
        function logout(){localStorage.removeItem('adminToken');token=null;currentUser=null;location.reload();}
        function switchTab(name){
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            event.target.classList.add('active');document.getElementById(name).classList.add('active');
            if(name==='dashboard')loadDashboard();
            if(name==='users')loadUsers();
            if(name==='unknown')loadUnknownRosters();
            if(name==='roster')loadRosterTree();
        }
        
        async function loadDashboard(){
            try{
                const res=await fetch('/api/admin/stats',{headers:{Authorization:`Bearer ${token}`}});
                const data=await res.json();
                const grid=document.getElementById('statsGrid');
                grid.innerHTML=`
                    <div class="stat-card"><h3>Total Users</h3><div class="value">${data.users.total}</div><div class="label">Registered pilots</div></div>
                    <div class="stat-card"><h3>New Users (7 days)</h3><div class="value">${data.users.recent_7_days}</div><div class="label">Recent registrations</div></div>
                    <div class="stat-card"><h3>Unknown Rosters</h3><div class="value">${data.unknown_rosters.recent_7_days}</div><div class="label">Reported in last 7 days</div></div>
                `+data.unknown_rosters.by_status.map(s=>`<div class="stat-card"><h3>${s.status.toUpperCase()}</h3><div class="value">${s.count}</div><div class="label">${s.total_reports} total reports</div></div>`).join('');
                if(data.unknown_rosters.top_patterns.length){
                    document.getElementById('topPatterns').innerHTML=`<h3 style="margin:30px 0 15px">Top Reported Patterns</h3><table><thead><tr><th>Pattern</th><th>Occurrences</th><th>Total Reports</th></tr></thead><tbody>${data.unknown_rosters.top_patterns.map(p=>`<tr><td><code>${escapeHtml(p.pattern)}</code></td><td>${p.occurrences}</td><td>${p.total_reports}</td></tr>`).join('')}</tbody></table>`;
                }
            }catch(e){console.error(e);}
        }
        
        async function loadUsers(offset=0){
            usersOffset=offset;const search=document.getElementById('userSearch').value;
            try{
                const params=new URLSearchParams({limit:LIMIT,offset,search});
                const res=await fetch(`/api/admin/users?${params}`,{headers:{Authorization:`Bearer ${token}`}});
                const data=await res.json();
                const tbl=document.getElementById('usersTable');
                if(data.users.length===0){tbl.innerHTML='<div class="empty-state"><p>No users found</p></div>';return;}
                tbl.innerHTML=`<table><thead><tr><th>Staff #</th><th>Name</th><th>Email</th><th>Rank</th><th>Airline</th><th>Registered</th><th>Last Login</th></tr></thead><tbody>${data.users.map(u=>`<tr><td>${u.staff_number||'-'}</td><td>${u.first_name} ${u.last_name}</td><td>${u.email}</td><td>${u.rank||'-'}</td><td>${u.airline_code||'-'}</td><td>${formatDate(u.registered_at)}</td><td>${u.last_login_at?formatDate(u.last_login_at):'Never'}</td></tr>`).join('')}</tbody></table>`;
                renderPagination('usersPagination',offset,data.total,loadUsers);
            }catch(e){console.error(e);}
        }
        
        async function loadUnknownRosters(offset=0){
            unknownOffset=offset;const status=document.getElementById('statusFilter').value,sort=document.getElementById('sortFilter').value,search=document.getElementById('unknownSearch').value;
            try{
                const params=new URLSearchParams({status,sort,order:'DESC',limit:LIMIT,offset,search});
                const res=await fetch(`/api/admin/unknown-rosters?${params}`,{headers:{Authorization:`Bearer ${token}`}});
                const data=await res.json();
                const tbl=document.getElementById('unknownTable');
                if(data.unknown_rosters.length===0){tbl.innerHTML='<div class="empty-state"><p>No unknown rosters found</p></div>';return;}
                tbl.innerHTML=`<table><thead><tr><th>Status</th><th>Raw Text</th><th>User</th><th>Date</th><th>Reports</th><th>First/Last Reported</th><th>Action</th></tr></thead><tbody>${data.unknown_rosters.map(r=>`<tr><td><span class="badge badge-${r.status}">${r.status}</span></td><td><code style="font-size:12px">${escapeHtml(r.raw_text.substring(0,50))}...</code></td><td>${r.email?r.email.split('@')[0]:'Unknown'}</td><td>${r.iso_date||'-'}</td><td>${r.report_count}</td><td style="font-size:11px">${formatDate(r.reported_at)}<br>${formatDate(r.last_reported_at)}</td><td><button onclick="viewUnknownDetail('${r.id}')" style="padding:6px 12px;background:#667eea;color:white;border:none;border-radius:4px;cursor:pointer">View</button></td></tr>`).join('')}</tbody></table>`;
                renderPagination('unknownPagination',offset,data.total,loadUnknownRosters);
            }catch(e){console.error(e);}
        }
        
        async function viewUnknownDetail(id){
            try{
                const res=await fetch(`/api/admin/unknown-rosters/${id}`,{headers:{Authorization:`Bearer ${token}`}});
                const data=await res.json();const r=data.unknown_roster;
                document.getElementById('modalContent').innerHTML=`
                    <div class="detail-row"><div class="detail-label">Status:</div><div class="detail-value"><span class="badge badge-${r.status}">${r.status}</span></div></div>
                    <div class="detail-row"><div class="detail-label">Raw Text:</div><div class="detail-value"><div class="code-block">${escapeHtml(r.raw_text)}</div></div></div>
                    <div class="detail-row"><div class="detail-label">User:</div><div class="detail-value">${r.email} (${r.first_name} ${r.last_name})</div></div>
                    <div class="detail-row"><div class="detail-label">Staff Number:</div><div class="detail-value">${r.staff_number||'-'}</div></div>
                    <div class="detail-row"><div class="detail-label">Date:</div><div class="detail-value">${r.iso_date||'-'} (${r.weekday||'-'}, Day ${r.day_number||'-'})</div></div>
                    <div class="detail-row"><div class="detail-label">Detected:</div><div class="detail-value">Kind: ${r.detected_kind||'-'}, Type: ${r.detected_type||'-'}</div></div>
                    <div class="detail-row"><div class="detail-label">Device:</div><div class="detail-value">${r.device_model||'-'} (iOS ${r.ios_version||'-'})</div></div>
                    <div class="detail-row"><div class="detail-label">Report Count:</div><div class="detail-value">${r.report_count}</div></div>
                    <div class="detail-row"><div class="detail-label">First Reported:</div><div class="detail-value">${formatDate(r.reported_at)}</div></div>
                    <div class="detail-row"><div class="detail-label">Last Reported:</div><div class="detail-value">${formatDate(r.last_reported_at)}</div></div>
                    ${r.resolved_at?`<div class="detail-row"><div class="detail-label">Resolved:</div><div class="detail-value">${formatDate(r.resolved_at)} by ${r.resolved_by}</div></div><div class="detail-row"><div class="detail-label">Notes:</div><div class="detail-value">${r.resolution_notes||'-'}</div></div>`:''}
                    <div style="margin-top:20px;display:flex;gap:10px">${r.status==='pending'?`<button onclick="updateStatus('${r.id}','resolved')" class="btn btn-success">Mark Resolved</button><button onclick="updateStatus('${r.id}','ignored')" class="btn btn-secondary">Ignore</button>`:''}<button onclick="deleteUnknown('${r.id}')" class="btn btn-danger">Delete</button></div>
                `;
                document.getElementById('detailModal').classList.add('active');
            }catch(e){console.error(e);}
        }
        
        async function updateStatus(id,status){const notes=prompt(`Resolution notes for ${status}:`);if(notes===null)return;try{const res=await fetch(`/api/admin/unknown-rosters/${id}`,{method:'PATCH',headers:{Authorization:`Bearer ${token}`,'Content-Type':'application/json'},body:JSON.stringify({status,resolution_notes:notes})});if(res.ok){alert('Status updated!');closeModal();loadUnknownRosters(unknownOffset);}else alert('Failed');}catch(e){alert('Network error');}}
        async function deleteUnknown(id){if(!confirm('Delete this unknown roster?'))return;try{const res=await fetch(`/api/admin/unknown-rosters/${id}`,{method:'DELETE',headers:{Authorization:`Bearer ${token}`}});if(res.ok){alert('Deleted!');closeModal();loadUnknownRosters(unknownOffset);}else alert('Failed');}catch(e){alert('Network error');}}
        function closeModal(){document.getElementById('detailModal').classList.remove('active');}
        function renderPagination(el,offset,total,loadFunc){const pages=Math.ceil(total/LIMIT),page=Math.floor(offset/LIMIT)+1;document.getElementById(el).innerHTML=`<button ${offset===0?'disabled':''} onclick="${loadFunc.name}(${offset-LIMIT})">‚Üê Previous</button><span>Page ${page} of ${pages} (${total} total)</span><button ${offset+LIMIT>=total?'disabled':''} onclick="${loadFunc.name}(${offset+LIMIT})">Next ‚Üí</button>`;}
        let searchTimeout;function searchUsers(){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>loadUsers(0),500);}function searchUnknown(){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>loadUnknownRosters(0),500);}
        function formatDate(d){if(!d)return'-';return new Date(d).toLocaleString('en-GB',{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'UTC'});}
        function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

        /* ========== ENHANCED ROSTER VIEWER ========== */
        async function loadRosterTree(){
            const tree=document.getElementById('rosterTree');
            try{
                const res=await fetch('/api/roster/periods',{headers:{Authorization:`Bearer ${token}`}});
                const data=await res.json();
                if(!data.periods.length){tree.innerHTML='<div class="empty-state"><p>No roster periods found</p></div>';return;}
                tree.innerHTML=data.periods.map(p=>`
                    <div class="roster-period" onclick="togglePeriod('${p.id}')">
                        <div class="period-header">
                            <div>
                                <div class="period-title">üìÖ ${p.period_start} ‚Üí ${p.period_end}</div>
                                <div class="period-meta">Crew ID: <strong>${p.crew_id}</strong> | Versions: <strong>${p.version_count}</strong> | Days: <strong>${p.total_days}</strong> | Last Updated: ${formatDate(p.last_updated_at)}
                                    <button class="btn-danger" style="padding:4px 12px;font-size:11px;margin-left:10px;width:auto;display:inline-block" onclick="deletePeriod(event,'${p.id}','${p.crew_id}','${p.period_start}')">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                        </div>
                        <div class="period-arrow" id="arrow-${p.id}">‚ñ∂</div>
                        <div id="days-${p.id}" class="roster-days-container"></div>
                    </div>
                `).join('');
            }catch(e){console.error(e);tree.innerHTML='<div class="empty-state"><p>Error loading rosters</p></div>';}
        }
        
        function togglePeriod(periodId){
            const container=document.getElementById(`days-${periodId}`);
            const arrow=document.getElementById(`arrow-${periodId}`);
            if(container.classList.contains('open')){
                container.classList.remove('open');
                arrow.classList.remove('open');
            }else{
                container.classList.add('open');
                arrow.classList.add('open');
                if(!container.dataset.loaded)loadDays(periodId);
            }
        }
        
// In loadDays(), add a safety check
async function loadDays(periodId){
    const container=document.getElementById(`days-${periodId}`);
    container.innerHTML='<div class="loading"><div class="spinner"></div>Loading days...</div>';
    try{
        const res=await fetch(`/api/roster/days?period_id=${periodId}`,{headers:{Authorization:`Bearer ${token}`}});
        const data=await res.json();
        if(!data.days.length){container.innerHTML='<div style="padding:20px;color:#999">No days found</div>';return;}
        
        // ‚úÖ Filter to ensure only active days are rendered
        const activeDays = data.days.filter(d => d.is_active_for_date);
        
        container.innerHTML=activeDays.map(d=>`
            <div class="roster-day-item" onclick="toggleDay(event,'${d.id}')">
                <div class="day-header">
                    <div>
                        <span class="day-date">${d.iso_date}</span> <strong>${d.weekday}</strong> (Day ${d.day_number})
                    </div>
                    <span class="day-arrow" id="day-arrow-${d.id}">‚ñº</span>
                </div>
                <div class="day-info">Raw: <code>${escapeHtml(d.raw_text||'No duty')}</code> ${d.has_changes?'<span style="color:#dc3545;font-weight:700">‚ö† HAS CHANGES</span>':''}</div>
                <div id="duties-${d.id}" class="duties-container open"></div>
            </div>
        `).join('');
        container.dataset.loaded='true';
        activeDays.forEach(d=>loadDuties(d.id));
    }catch(e){container.innerHTML='<div style="color:red;padding:20px">Error loading days</div>';}
}
        
        function toggleDay(event,dayId){
            event.stopPropagation();
            const container=document.getElementById(`duties-${dayId}`);
            const arrow=document.getElementById(`day-arrow-${dayId}`);
            if(container.classList.contains('open')){
                container.classList.remove('open');
                arrow.textContent='‚ñ∂';
            }else{
                container.classList.add('open');
                arrow.textContent='‚ñº';
            }
        }
        
        async function loadDuties(dayId){
            const container=document.getElementById(`duties-${dayId}`);
            try{
                const res=await fetch(`/api/roster/days/${dayId}/duties`,{headers:{Authorization:`Bearer ${token}`}});
                if(!res.ok)throw new Error('No duties');
                const data=await res.json();
                if(!data.duties.length){container.innerHTML='<div style="padding:10px;color:#999;font-size:13px">No duties assigned</div>';return;}
                container.innerHTML=data.duties.map((duty,idx)=>`
                    <div class="duty-card">
                        <div class="duty-header">
                            <span class="duty-kind-badge">${duty.duty_kind}</span>
                            ${duty.duty_type?`<span class="duty-type-badge">${duty.duty_type}</span>`:''}
                            <span style="font-size:11px;color:#999">Seq: ${duty.sequence_order}</span>
                        </div>
                        <div class="duty-field"><strong>Rule ID:</strong> ${duty.rule_id||'-'}</div>
                        <div class="duty-field"><strong>Check-In:</strong> ${duty.check_in||'-'} @ ${duty.check_in_station||'-'} ${duty.check_in_date?`(${formatDate(duty.check_in_date)})`:''}` +`</div>
                        <div class="duty-field"><strong>Check-Out:</strong> ${duty.check_out||'-'} @ ${duty.check_out_station||'-'} ${duty.check_out_date?`(${formatDate(duty.check_out_date)})`:''}` +`</div>
                        ${duty.is_instructor_duty?`<div class="duty-field"><strong>üë®‚Äçüè´ Instructor Duty:</strong> Yes</div>`:''}
                        ${duty.learning_title?`<div class="duty-field"><strong>üìö Learning Title:</strong> ${duty.learning_title}</div>`:''}
                        ${duty.notes&&duty.notes.length?`<div class="duty-notes"><strong>üìù Notes:</strong> ${duty.notes.join(', ')}</div>`:''}
                        ${duty.sectors&&duty.sectors.length?`
                            <div class="sectors-container">
                                <strong style="font-size:13px;color:#28a745">‚úàÔ∏è Sectors (${duty.sectors.length}):</strong>
                                ${duty.sectors.map(s=>`
                                    <div class="sector-card">
                                        <div class="sector-route">‚úà ${s.flight_number} | ${s.dep_iata} ${s.dep_time} ‚Üí ${s.arr_iata} ${s.arr_time}</div>
                                        ${s.aircraft?`<div class="sector-field"><strong>Aircraft:</strong> ${s.aircraft}</div>`:''}
                                        ${s.dep_time_dt?`<div class="sector-field"><strong>Departure DateTime:</strong> ${formatDate(s.dep_time_dt)} ${s.dep_time_is_local?'üïê Local':''}</div>`:''}
                                        ${s.arr_time_dt?`<div class="sector-field"><strong>Arrival DateTime:</strong> ${formatDate(s.arr_time_dt)} ${s.arr_time_is_local?'üïê Local':''}</div>`:''}
                                        ${s.kind_training_duty&&s.kind_training_duty!=='none'?`<div class="sector-field"><strong>üë®‚Äçüè´ Training:</strong> ${s.kind_training_duty}</div>`:''}
                                        ${s.cockpit_crew&&s.cockpit_crew.length?`<div class="sector-field"><strong>üë®‚Äç‚úàÔ∏è Cockpit Crew:</strong><div class="crew-list">${s.cockpit_crew.map(c=>`<span class="crew-badge">${c}</span>`).join('')}</div></div>`:''}
                                        ${s.cabin_crew&&s.cabin_crew.length?`<div class="sector-field"><strong>üë®‚Äç‚úàÔ∏è Cabin Crew:</strong><div class="crew-list">${s.cabin_crew.map(c=>`<span class="crew-badge">${c}</span>`).join('')}</div></div>`:''}
                                    </div>
                                `).join('')}
                            </div>
                        `:'<div style="padding:8px;color:#999;font-size:12px">No sectors</div>'}
                        <button class="view-json-btn" onclick="viewDutyJSON(${JSON.stringify(duty).replace(/"/g,'&quot;')})">üìÑ View Full JSON</button>
                    </div>
                `).join('');
            }catch(e){container.innerHTML='<div style="color:red;padding:10px;font-size:12px">Error loading duties</div>';}
        }
        
        function viewDutyJSON(duty){
            const modal=document.getElementById('detailModal');
            const content=document.getElementById('modalContent');
            content.innerHTML=`
                <h3 style="margin-bottom:15px">üîç Complete Duty Assignment JSON</h3>
                <div class="json-viewer">${syntaxHighlight(JSON.stringify(duty,null,2))}</div>
            `;
            modal.classList.add('active');
        }
        
        function syntaxHighlight(json){
            json=json.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,m=>{
                let cls='json-number';
                if(/^"/.test(m)){
                    if(/:$/.test(m))cls='json-key';
                    else cls='json-string';
                }else if(/true|false/.test(m))cls='json-boolean';
                else if(/null/.test(m))cls='json-null';
                return '<span class="'+cls+'">'+m+'</span>';
            });
        }
        
        async function deletePeriod(event,periodId,crewId,periodStart){
            event.stopPropagation();
            if(!confirm(`Delete period for ${crewId} starting ${periodStart}?\n\nThis will permanently delete all days, duties, and sectors for this period.`))return;
            try{
                const res=await fetch(`/api/roster/periods/${periodId}`,{
                    method:'DELETE',
                    headers:{Authorization:`Bearer ${token}`}
                });
                if(!res.ok)throw new Error('Delete failed');
                alert('Period deleted successfully');
                loadRosterTree();
            }catch(e){
                alert('Error deleting period: '+e.message);
            }
        }
    </script>
</body>
</html>